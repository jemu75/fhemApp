{"version":3,"file":"directiveComponent.mjs","names":["h","mergeProps","render","resolveComponent","useDirectiveComponent","component","props","concreteComponent","mounted","el","binding","vnode","value","children","text","innerHTML","provides","ctx","instance","$","findComponentParent","node","appContext","Object","assign","create","unmounted","root","stack","Set","walk","child","add","Array","isArray","result","subTree","delete","Error","from","reverse"],"sources":["../../src/composables/directiveComponent.ts"],"sourcesContent":["// Utilities\nimport { h, mergeProps, render, resolveComponent } from 'vue'\n\n// Types\nimport type {\n  Component,\n  ComponentInternalInstance,\n  ComponentPublicInstance,\n  ConcreteComponent,\n  DirectiveBinding,\n  ObjectDirective,\n  VNode,\n} from 'vue'\n\nexport const useDirectiveComponent = (\n  component: string | Component,\n  props?: any\n): ObjectDirective => {\n  const concreteComponent = (typeof component === 'string'\n    ? resolveComponent(component)\n    : component) as ConcreteComponent\n\n  return {\n    mounted (el: HTMLElement, binding: DirectiveBinding, vnode: VNode) {\n      const { value } = binding\n\n      // Get the children from the props or directive value, or the element's children\n      const children = props.text || value.text || el.innerHTML\n\n      // If vnode.ctx is the same as the instance, then we're bound to a plain element\n      // and need to find the nearest parent component instance to inherit provides from\n      const provides = (vnode.ctx === binding.instance!.$\n        ? findComponentParent(vnode, binding.instance!.$)?.provides\n        : vnode.ctx?.provides) ?? binding.instance!.$.provides\n\n      const node = h(concreteComponent, mergeProps(props, value), children)\n      node.appContext = Object.assign(\n        Object.create(null),\n        (binding.instance as ComponentPublicInstance).$.appContext,\n        { provides }\n      )\n\n      render(node, el)\n    },\n    unmounted (el: HTMLElement) {\n      render(null, el)\n    },\n  }\n}\n\nfunction findComponentParent (vnode: VNode, root: ComponentInternalInstance): ComponentInternalInstance | null {\n  // Walk the tree from root until we find the child vnode\n  const stack = new Set<VNode>()\n  const walk = (children: VNode[]): boolean => {\n    for (const child of children) {\n      if (!child) continue\n\n      if (child === vnode) {\n        return true\n      }\n\n      stack.add(child)\n      if (Array.isArray(child.children)) {\n        const result = walk(child.children as VNode[])\n        if (result) {\n          return result\n        }\n      } else if (child.component?.vnode) {\n        const result = walk([child.component?.subTree])\n        if (result) {\n          return result\n        }\n      }\n      stack.delete(child)\n    }\n\n    return false\n  }\n  if (!walk([root.subTree])) {\n    throw new Error('Could not find original vnode')\n  }\n\n  // Return the first component parent\n  const result = Array.from(stack).reverse()\n  for (const child of result) {\n    if (child.component) {\n      return child.component\n    }\n  }\n  return root\n}\n"],"mappings":"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"}